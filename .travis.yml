language: python
dist: bionic

before_install:
  - git clone --depth 1 --branch v2.1.0-2 https://github.com/ait-aecid/aminer-ansible.git roles/aminer
  - cp $PWD/source/root/etc/aminer/conf-available/generic/ApacheAccessModel.py $PWD/source/root/etc/aminer/conf-enabled/ApacheAccessModel.py
  - ln -s $PWD/source/root/usr/lib/logdata-anomaly-miner/aminer $PWD/aecid-testsuite/aminer
  - ln -s $PWD/source/root/etc/aminer/template_config.py $PWD/aecid-testsuite/demo/AMiner/template_config.py
  - ln -s $PWD/source/root/etc/aminer/template_config.yml $PWD/aecid-testsuite/demo/AMiner/template_config.yml
  - sed -e "s+{{SOURCEDIR}}+$PWD+g" .playbook.yml > playbook.yml

install:
  - sudo apt-get update -y
  - sudo apt-get install -y ansible
  - sudo ansible-playbook -e "aminer_pkgrespath=/usr/lib/python3.6/site-packages aminer_pippath=/usr/lib/python3.6/site-packages" playbook.yml
  - sudo apt-get install -y exim4 procps mailutils
  - sudo pip3 install coverage
  - cd aecid-testsuite
  - sudo chmod +x runUnittests.sh
  - sudo chmod +x runAMinerDemo.sh
  - sudo chmod +x runAMinerIntegrationTest.sh
  - sudo chmod +x runCoverageTests.sh

script:
  - sudo pip3 install psutil
  - sudo python3 -c """import psutil; print(psutil.net_connections())"""
  - echo "dc_local_interfaces='127.0.0.1'" | sudo tee -a /etc/exim4/update-exim4.conf.conf
  - sudo cat /etc/exim4/update-exim4.conf.conf
  - sudo rm /var/log/exim4/mainlog
  - sudo service exim4 restart
  - sudo service exim4 status
  - sudo lsof -i:25
  - sudo cat /var/log/exim4/mainlog
  - sudo python3 -c """import smtplib; smtp_obj = smtplib.SMTP('127.0.0.1', timeout=None); print(smtp_obj); smtp_obj.quit()"""
  - sudo python3 -c """import psutil; print(psutil.net_connections())"""
  - sudo service exim4 status
  - sudo lsof -i:25
  - sudo cat /var/log/exim4/mainlog
  - python3 -c """import socket; a_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM); location = ('127.0.0.1', 25); result_of_check = a_socket.connect_ex(location); print(result_of_check); a_socket.close()"""
  - python3 -c """import socket; a_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM); location = ('127.0.0.1', 25); result_of_check = a_socket.connect(location); print(result_of_check); a_socket.close()"""
  - sudo python3 -c """import socket; print(socket.getfqdn()); print(socket.gethostbyname(socket.gethostname())); import smtplib; soc = smtplib.SMTP('localhost', timeout=None); soc.debuglevel = 3; print('local_hostname', soc.local_hostname); s = soc._get_socket('127.0.0.1', 25, None); print('first socket ', s); s.close(); print('getaddrinfo', socket.getaddrinfo('127.0.0.1', 25, 0, 1)); print('create_connection'); create_soc = socket.create_connection(('127.0.0.1', 25), None); print('create_connection_soc', create_soc); create_soc.close(); soc.quit()"""
  - sudo python3 -c """import smtplib; smtp_obj = smtplib.SMTP('localhost', timeout=None); print(smtp_obj); smtp_obj.quit()"""
  - sudo python3 -c """import smtplib; smtp_obj = smtplib.SMTP('localhost', timeout=None); print(smtp_obj); smtp_obj.quit()"""
  - python3 -c """import smtplib; smtp_obj = smtplib.SMTP('localhost', timeout=None); print(smtp_obj); smtp_obj.quit()"""
  - sudo python3 -c """import smtplib; smtp_obj = smtplib.SMTP('127.0.0.1', port=25, local_hostname='localhost', timeout=None); print(smtp_obj); smtp_obj.quit()"""
  - sudo python3 -c """import smtplib; smtp_obj = smtplib.SMTP('127.0.0.1', port=25, timeout=None); print(smtp_obj); smtp_obj.quit()"""
  - sudo python3 -c """import smtplib; smtp_obj = smtplib.SMTP(timeout=None); smtp_obj.connect(); print(smtp_obj); smtp_obj.quit()"""
  - sudo iptables -vL
  - sudo ls -la /var/mail
  - echo d | sudo mail -u mail
  - sudo python3 -m unittest unit/events/DefaultMailNotificationEventHandlerTest.py
  - sudo ls -la /var/mail
  - echo p | sudo mail -u mail
  - ./runUnittests.sh
  - ./runAMinerDemo.sh demo/AMiner/demo-config.py
  - ./runAMinerDemo.sh demo/AMiner/jsonConverterHandler-demo-config.py
  - ./runAMinerDemo.sh demo/AMiner/template_config.py
  - ./runAMinerDemo.sh demo/AMiner/template_config.yml
  - ./runAMinerDemo.sh demo/AMiner/demo-config.yml
  - ./runAMinerIntegrationTest.sh aminerIntegrationTest.sh config.py
  - ./runAMinerIntegrationTest.sh aminerIntegrationTest2.sh config21.py config22.py
  - ./runCoverageTests.sh

after_script:
  - cd ..
  - rm $PWD/aecid-testsuite/aminer
  - rm $PWD/source/root/usr/lib/logdata-anomaly-miner/ApacheAccessModel.py
  - rm $PWD/aecid-testsuite/demo/AMiner/template_config.py
